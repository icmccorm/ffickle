---
title: "Improper Type Errors"
output: html_notebook
---


```{r setup, echo = FALSE}
library(dplyr)
library(readr)
library(tidyr)  
options(dplyr.summarise.inform = FALSE)

all_path <- file.path("../all.csv")
all <- read_csv(
    all_path,
    show_col_types = FALSE
)
finished_early_path <- file.path("../locations/finished_early.csv")
finished_early <- read_csv(
    finished_early_path,
    show_col_types = FALSE
)

finished_late_path <- file.path("../locations/finished_late.csv")
finished_late <- read_csv(
    finished_late_path,
    show_col_types = FALSE
)
foreign_abis_path <- file.path("../locations/foreign_module_abis.csv")
foreign_abis <- read_csv(
    foreign_abis_path,
    show_col_types = FALSE
) %>% filter(abi == "C")
einfo_path <- file.path("../locations/error_info.csv")
einfo <- read_csv(
    einfo_path,
    show_col_types = FALSE
)
discriminant_counts_path <- file.path("../locations/category_error_counts.csv")
discriminant_counts <- read_csv(
    discriminant_counts_path,
    show_col_types = FALSE
) %>% inner_join(einfo, by = c("err_id", "crate_name"))

discriminmant_names_path <- file.path("../discriminants.csv")
discriminant_names <- read_csv(
    discriminmant_names_path,
    show_col_types = FALSE
)

```
```{r include = FALSE}
discriminant_counts %>%
  group_by(crate_name, category) %>%
  summarize(num_errs = sum(count)) %>% 
  group_by(category) %>% 
  summarize(
    num_crates = n(), 
    mean_errs = mean(num_errs), 
    max_errs = max(num_errs), 
    min_errs = min(num_errs), 
    stdev_errs = sd(num_errs)
  )
unique_errors <- einfo %>% 
  select(discriminant, err_text) %>% 
  unique %>% 
  nrow
```
We observed `r sum(discriminant_counts$count)` type errors in foreign bindings. There were `r unique_errors` unique errors.

```{r echo = FALSE}
named_counts <- discriminant_counts %>% inner_join(discriminant_names, by=c("discriminant"))
decls <- named_counts %>% filter(category %in% c("foreign_functions"))
defns <- named_counts %>% filter(category %in% c("rust_functions"))
decls_items <- named_counts %>% filter(category %in% c("static_items"))

discrim_counts <- einfo %>% 
  select(discriminant, err_text) %>% 
  unique %>% 
  group_by(discriminant) %>% 
  summarize(n_unique=n())

decls_items_counts <- 
  decls_items %>% 
  group_by(type_name) %>% 
  summarize(fi_count = sum(count)) %>% 
  unique

decls_counts <- decls %>% 
  group_by(type_name) %>% 
  summarize(ff_count = sum(count)) %>% 
  unique

defns_counts <- defns %>% 
  group_by(type_name) %>% 
  summarize(ef_count = sum(count)) %>% 
  unique

final <- discriminant_names %>% 
  left_join(decls_counts, by=c("type_name")) %>% 
  left_join(decls_items_counts, by=c("type_name")) %>% 
  left_join(defns_counts, by=c("type_name")) %>% 
  left_join(discrim_counts, by=c("discriminant")) %>% 
  mutate(across(where(is.numeric), ~ replace_na(.x, 0)))

final$total_occurrences <- final$ff_count + final$fi_count + final$ef_count
final %>% filter(total_occurrences > 0) %>% arrange(type_name)
```